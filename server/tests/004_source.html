<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta content="width=device-width, initial-scale=1" name="viewport"><title>[Rust] 四分木による経路探索</title><link rel="canonical" href="https://zenn.dev/msakuta/articles/fdea72a964dd08"><meta name="twitter:card" content="summary_large_image"><meta property="og:url" content="https://zenn.dev/msakuta/articles/fdea72a964dd08"><meta property="og:title" content="[Rust] 四分木による経路探索"><meta property="og:image" content="https://res.cloudinary.com/zenn/image/upload/s--hal_3QHt--/c_fit%2Cg_north_west%2Cl_text:notosansjp-medium.otf_55:%255BRust%255D%2520%25E5%259B%259B%25E5%2588%2586%25E6%259C%25A8%25E3%2581%25AB%25E3%2582%2588%25E3%2582%258B%25E7%25B5%258C%25E8%25B7%25AF%25E6%258E%25A2%25E7%25B4%25A2%2Cw_1010%2Cx_90%2Cy_100/g_south_west%2Cl_text:notosansjp-medium.otf_37:msakuta%2Cx_203%2Cy_98/g_south_west%2Ch_90%2Cl_fetch:aHR0cHM6Ly9saDMuZ29vZ2xldXNlcmNvbnRlbnQuY29tL2EvQUFUWEFKeG5tZ0ZYQlJsZjJpZVh1QWlwOG9LaFdpT2FSczg2dXRzWlcwN3o9czk2LWM=%2Cr_max%2Cw_90%2Cx_87%2Cy_72/og-base.png"><meta property="og:type" content="article"><meta property="og:site_name" content="Zenn"><meta content="https://lh3.googleusercontent.com/a/AATXAJxnmgFXBRlf2ieXuAip8oKhWiOaRs86utsZW07z=s96-c" name="zenn:image"><meta content="msakutaさんによる記事" name="zenn:description"><meta name="next-head-count" content="12"><script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-PVQ2KDWHD2&amp;l=dataLayer&amp;cx=c"></script><script async="" src="https://www.googletagmanager.com/gtm.js?id=GTM-K42DRM8"></script><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-K42DRM8');</script><script async="" src="https://www.googletagmanager.com/gtag/js"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());</script><script src="https://embed.zenn.studio/js/listen-embed-event.js"></script><style>
            @font-face {
              font-family: 'Inter';
              font-weight: 600;
              font-display: swap;
              src: local(''), url('https://zenn.dev/fonts/inter-v3-latin-600.woff2') format('woff2');
            }
            @font-face {
              font-family: 'Inter';
              font-weight: 700;
              font-display: swap;
              src: local(''), url('https://zenn.dev/fonts/inter-v3-latin-700.woff2') format('woff2');
            }</style><meta content="Zenn" name="apple-mobile-web-app-title"><link href="https://zenn.dev/images/logo-transparent.png" rel="shortcut icon" type="image/png"><link href="https://zenn.dev/images/icon.png" rel="apple-touch-icon-precomposed" type="image/png"><link rel="preload" href="https://zenn.dev/_next/static/css/aa7c92166c16e0a6.css" as="style"><link rel="stylesheet" href="https://zenn.dev/_next/static/css/aa7c92166c16e0a6.css" data-n-g=""><link rel="preload" href="https://zenn.dev/_next/static/css/2244d099bd6e69f7.css" as="style"><link rel="stylesheet" href="https://zenn.dev/_next/static/css/2244d099bd6e69f7.css" data-n-p=""><noscript data-n-css=""></noscript><script defer="" nomodule="" src="https://zenn.dev/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="https://zenn.dev/_next/static/chunks/webpack-c15094771d31a925.js" defer=""></script><script src="https://zenn.dev/_next/static/chunks/framework-ce84985cd166733a.js" defer=""></script><script src="https://zenn.dev/_next/static/chunks/main-f5cb3ceb95c17179.js" defer=""></script><script src="https://zenn.dev/_next/static/chunks/pages/_app-1818af8cf5f40bda.js" defer=""></script><script src="https://zenn.dev/_next/static/chunks/2385-ce0c8b6538fea329.js" defer=""></script><script src="https://zenn.dev/_next/static/chunks/7103-512a8306d5aae78b.js" defer=""></script><script src="https://zenn.dev/_next/static/chunks/4077-6b950217b839f1cf.js" defer=""></script><script src="https://zenn.dev/_next/static/chunks/3899-fe0888f80b32ee3a.js" defer=""></script><script src="https://zenn.dev/_next/static/chunks/733-d4fc762e43a175bc.js" defer=""></script><script src="https://zenn.dev/_next/static/chunks/pages/%5Busername%5D/articles/%5Bslug%5D-c83991c703518579.js" defer=""></script><script src="https://zenn.dev/_next/static/piX8DDrzno6pbqKClrLHx/_buildManifest.js" defer=""></script><script src="https://zenn.dev/_next/static/piX8DDrzno6pbqKClrLHx/_ssgManifest.js" defer=""></script><link rel="stylesheet" type="text/css" href="https://zenn.dev/_next/static/css/c27bf6cd183bde69.css"></head><body data-use-twemoji="true"><script>const shouldUseTwemoji = !/(googlebot|macintosh|macintel|macppc|mac68k|macos|iphone|ipad)/i.test(window.navigator.userAgent);
        if(shouldUseTwemoji) document.body.setAttribute("data-use-twemoji", "true");</script><div id="__next"><header class="AppHeader_header__0obie"><div class="Container_wide__i6D5f Container_common__bSTKj"><div class="AppHeader_inner__Nqogt"><a class="AppHeader_homeLink__sgij0" href="/"><svg x="0px" y="0px" viewBox="0 0 377.4 88.3" aria-label="Zenn | エンジニアのための情報共有コミュニティ" height="22"><title>Zenn</title><g fill="#111"><path d="M233,56.8h-39c0.5,3.5,2.2,6.8,4.8,9.2c2.7,2.3,6.2,3.5,9.8,3.4c2.8,0,5.6-0.5,8.2-1.7c2.5-1.1,4.8-2.8,6.5-5l8.2,9.5 c-2.5,3.4-5.7,6.1-9.5,7.9c-4.6,2.2-9.6,3.3-14.7,3.2c-5.7,0.1-11.4-1.2-16.5-4c-4.5-2.5-8.2-6.3-10.7-10.9s-3.8-9.8-3.7-15.1v-2.2 c-0.1-5.7,1.1-11.3,3.5-16.5c2.2-4.7,5.7-8.6,10.1-11.3c4.7-2.8,10.1-4.2,15.5-4.1c5.2-0.1,10.3,1.1,14.9,3.7 c4.1,2.5,7.4,6.2,9.4,10.5c2.2,5.1,3.3,10.5,3.2,16.1V56.8z M216.1,43.9c0.1-2.9-0.9-5.7-2.8-7.9c-1.8-1.9-4.4-2.9-7.9-2.9 c-2.9-0.1-5.8,1.1-7.7,3.2c-2,2.6-3.3,5.7-3.6,9h22V43.9z"></path><path d="M128.3,67.9h36.1v14.7h-56.9V72l35.8-54.3h-36.2V2.9h56.6v10.4L128.3,67.9z"></path><path d="M248.8,50.7c0-19.1,12.7-29.2,28.2-29.2s27.9,10.1,27.9,29.2V82h-16V51.4c0-10.6-4.8-16.1-12-16.1s-12.4,5.5-12.4,16.1 v30.7h-15.8L248.8,50.7L248.8,50.7z"></path><path d="M320.3,50.7c0-19.1,12.7-29.2,28.2-29.2s27.9,10.1,27.9,29.2V82h-16V51.4c0-10.6-4.8-16.1-12-16.1S336,40.8,336,51.4v30.7 h-15.8L320.3,50.7L320.3,50.7z"></path></g><path fill="#3EA8FF" class="st0" d="M2.4,83.3h17c0.9,0,1.7-0.5,2.2-1.2L68.4,5.2C69,4.2,68.3,3,67.1,3H51c-0.8,0-1.5,0.4-1.9,1.1L1.6,81.9 C1.3,82.5,1.7,83.3,2.4,83.3z"></path><path fill="#3EA8FF" class="st0" d="M61,82.1l22.1-35.5c0.7-1.1-0.1-2.5-1.4-2.5H65.7c-0.6,0-1.2,0.3-1.5,0.8L41.5,81.2c-0.6,0.9,0.1,2.1,1.2,2.1 h16.3C59.8,83.3,60.6,82.9,61,82.1z"></path></svg></a><div class="FadeIn_fadeIn__O8JSZ "><div class="AppHeader_actionsArea__XPo58"><a aria-label="検索" class="AppHeader_searchLink__z70oa" id="header-search" href="/search"><svg viewBox="0 0 27 27" height="23" width="23"><path d="M11.56,3.43a8.26,8.26,0,0,0,0,16.52,8.18,8.18,0,0,0,5-1.72l4.7,4.7a1.1,1.1,0,0,0,1.56,0,1.09,1.09,0,0,0,0-1.55l0,0-4.7-4.7a8.18,8.18,0,0,0,1.72-5A8.28,8.28,0,0,0,11.56,3.43Zm0,2.2A6.06,6.06,0,1,1,5.5,11.69,6,6,0,0,1,11.56,5.63Z" fill="currentColor"></path></svg></a><button class="AppHeader_signInLink__K1JEF">Log in</button></div></div></div></div></header><article class="View_container__Tv3f8"><aside class="ContentStickyNavForMobile_container__E7YvT"><div class="Container_wide__i6D5f Container_common__bSTKj"><div class="ContentStickyNavForMobile_inner__IYD_r"><a class="ContentStickyNavForMobile_principalLink__4mD3j" href="/msakuta"><span class="ContentStickyNavForMobile_avatarContainer__sOyb6"><img alt="msakuta" class="AvatarImage_border__33_UE AvatarImage_plain__BCJNs " height="38" referrerpolicy="no-referrer" src="https://lh3.googleusercontent.com/a/AATXAJxnmgFXBRlf2ieXuAip8oKhWiOaRs86utsZW07z=s96-c" width="38"></span><span class="ContentStickyNavForMobile_displayName__n6JRq">msakuta</span></a><div class="ContentStickyNavForMobile_actions__jfqSs"><div class="ArticleMobileHeaderToc_toc__ShaqT"><button class="ArticleMobileHeaderToc_tocButton__2nWA_">目次<svg viewBox="0 0 27 27" class="ArticleMobileHeaderToc_arrowIcon__QZnYp" height="13" width="13"><path fill="currentColor" d="M12.74,20.53,3.48,11.35a.75.75,0,0,1,0-1.07L4.71,9.05a.75.75,0,0,1,1.07,0l7.49,7.41,7.49-7.41a.74.74,0,0,1,1.06,0l1.24,1.23a.77.77,0,0,1,0,1.07L13.8,20.53A.74.74,0,0,1,12.74,20.53Z"></path></svg></button></div><div style="margin-left:15px"><div class="LikeButton_container__lhHqp style-medium"><button aria-label="いいね" class="LikeButton_button__uWgw1"><svg class="LikeButton_svgLike___dmwM" viewBox="0 0 110 110"><path class="LikeButton_svgLikeLine__ncYg7" d="M73,24a23.78,23.78,0,0,0-15.89,6.19,3.14,3.14,0,0,1-4.18,0A23.81,23.81,0,0,0,37,24a22,22,0,0,0-22,22c0,16.67,19.64,32.82,25.11,37.93,2.84,2.65,6.15,5.64,8.92,8.13a8.9,8.9,0,0,0,11.9,0c2.77-2.49,6.07-5.48,8.91-8.13C75.37,78.81,95,62.66,95,46A22,22,0,0,0,73,24Z" fill="currentColor"></path><path class="LikeButton_svgLikeInner__AOG_t" d="M66.25,76.42c-.71.64-1.32,1.2-1.82,1.67-2.51,2.33-5.39,5-7.94,7.25a2.21,2.21,0,0,1-3,0C51,83,48.1,80.42,45.59,78.09c-.5-.47-1.12-1-1.82-1.67C38.09,71.29,23,57.67,23,46A14,14,0,0,1,37,32a15.92,15.92,0,0,1,11.65,5.23l4.73,5a2.2,2.2,0,0,0,3.23,0l4.72-5A16.06,16.06,0,0,1,73,32,14,14,0,0,1,87,46C87,57.67,71.93,71.29,66.25,76.42Z" fill="currentColor"></path><g class="LikeButton_svgLikeDecoration__X2v53"><circle cx="41.5" cy="9.5" fill="#3ea8ff" r="3.5"></circle><circle cx="98.5" cy="26.5" fill="#ffdc6e" r="3.5"></circle><circle cx="13" cy="19" fill="#c067f4" r="5"></circle><circle cx="77" cy="9" fill="#f76685" r="5"></circle><circle cx="26.5" cy="92.5" fill="#f76685" r="3.5"></circle><circle cx="105.5" cy="48.5" fill="#c067f4" r="3.5"></circle><circle cx="4.5" cy="60.5" fill="#3ea8ff" r="3.5"></circle><circle cx="94.5" cy="73.5" fill="#3ea8ff" r="1.5"></circle><circle cx="16.5" cy="75.5" fill="#ffdc6e" r="1.5"></circle><circle cx="78.5" cy="91.5" fill="#ffdc6e" r="1.5"></circle></g></svg></button></div></div></div></div></div></aside><header class="ArticleHeader_header__W_uDy"><div class="Container_wide__i6D5f Container_common__bSTKj"><div><div class="ArticleHeader_emoji__GEgLg"><span class="Emoji_twemoji__mFta9"><span class="Emoji_twemojiImg__Imjtw" style="background-image:url(https://asia-northeast1-zenn-dev-production.cloudfunctions.net/twemoji/✨.svg)"></span></span><span class="Emoji_nativeEmoji__JRjFi">✨</span></div><h1 class="ArticleHeader_title__ytjQW"><span style="font-size:0.9319999999999999em">[Rust] 四分木による経路探索</span></h1><div class="ArticleHeader_mobileMeta__JSlPu false"><div class="ArticleHeader_metaInfo__c_PQ5"><span class="ArticleHeader_pubDate__2tSO_"><span class="ArticleHeader_num__rSDj6">2023/03/18</span>に公開</span><span class="ArticleHeader_metaSeparator__cebmt">・</span><span class="ArticleHeader_lettersCount__RlJMo">約5,600字</span></div></div></div></div></header><div class="Container_wide__i6D5f Container_common__bSTKj"><div class="ContainerUndo_undoInSM__oglqo"><div class="View_inner__oKcz7"><div class="View_stickyShare__CmgmR"><div class="View_stickyShareInner__dFt2H"><div class="LikeButton_container__lhHqp style-large-white count-bottom"><button aria-label="いいね" class="LikeButton_button__uWgw1"><svg class="LikeButton_svgLike___dmwM" viewBox="0 0 110 110"><path class="LikeButton_svgLikeLine__ncYg7" d="M73,24a23.78,23.78,0,0,0-15.89,6.19,3.14,3.14,0,0,1-4.18,0A23.81,23.81,0,0,0,37,24a22,22,0,0,0-22,22c0,16.67,19.64,32.82,25.11,37.93,2.84,2.65,6.15,5.64,8.92,8.13a8.9,8.9,0,0,0,11.9,0c2.77-2.49,6.07-5.48,8.91-8.13C75.37,78.81,95,62.66,95,46A22,22,0,0,0,73,24Z" fill="currentColor"></path><path class="LikeButton_svgLikeInner__AOG_t" d="M66.25,76.42c-.71.64-1.32,1.2-1.82,1.67-2.51,2.33-5.39,5-7.94,7.25a2.21,2.21,0,0,1-3,0C51,83,48.1,80.42,45.59,78.09c-.5-.47-1.12-1-1.82-1.67C38.09,71.29,23,57.67,23,46A14,14,0,0,1,37,32a15.92,15.92,0,0,1,11.65,5.23l4.73,5a2.2,2.2,0,0,0,3.23,0l4.72-5A16.06,16.06,0,0,1,73,32,14,14,0,0,1,87,46C87,57.67,71.93,71.29,66.25,76.42Z" fill="currentColor"></path><g class="LikeButton_svgLikeDecoration__X2v53"><circle cx="41.5" cy="9.5" fill="#3ea8ff" r="3.5"></circle><circle cx="98.5" cy="26.5" fill="#ffdc6e" r="3.5"></circle><circle cx="13" cy="19" fill="#c067f4" r="5"></circle><circle cx="77" cy="9" fill="#f76685" r="5"></circle><circle cx="26.5" cy="92.5" fill="#f76685" r="3.5"></circle><circle cx="105.5" cy="48.5" fill="#c067f4" r="3.5"></circle><circle cx="4.5" cy="60.5" fill="#3ea8ff" r="3.5"></circle><circle cx="94.5" cy="73.5" fill="#3ea8ff" r="1.5"></circle><circle cx="16.5" cy="75.5" fill="#ffdc6e" r="1.5"></circle><circle cx="78.5" cy="91.5" fill="#ffdc6e" r="1.5"></circle></g></svg></button><span class="LikeButton_likedCount__oJfwh">25</span></div><span style="display:block;width:1px;height:1rem;flex-shrink:0"></span><a class="ShareButtons_buttonVertical__2oKnE" href="https://twitter.com/intent/tweet?url=https://zenn.dev/msakuta/articles/fdea72a964dd08&amp;text=%5BRust%5D%20%E5%9B%9B%E5%88%86%E6%9C%A8%E3%81%AB%E3%82%88%E3%82%8B%E7%B5%8C%E8%B7%AF%E6%8E%A2%E7%B4%A2%EF%BD%9Cmsakuta&amp;hashtags=zenn" rel="nofollow noopener noreferrer" target="_blank"><svg x="0px" y="0px" viewBox="0 0 27 27" style="enable-background:new 0 0 27 27" xml:space="preserve"><path fill="currentColor" d="M23.1,8.7c0,0.2,0,0.5,0,0.7c0,8-6.4,14.5-14.4,14.6c-0.1,0-0.1,0-0.2,0c-2.8,0-5.5-0.8-7.9-2.3c0.4,0,0.8,0.1,1.2,0.1 c2.3,0,4.6-0.8,6.3-2.1C6,19.6,4,18.2,3.3,16c0.3,0.1,0.7,0.1,1,0.1c0.5,0,0.9-0.1,1.4-0.2c-2.4-0.5-4.1-2.6-4.1-5.1v-0.1 c0.7,0.4,1.5,0.6,2.3,0.7c-1.5-1-2.2-2.5-2.2-4.3c0-0.9,0.2-1.8,0.7-2.6C5,7.8,8.8,9.7,13,9.9c-0.1-0.4-0.1-0.8-0.1-1.2 c0-2.8,2.2-5.2,5.2-5.2c1.5,0,2.8,0.6,3.8,1.7C23,5,24,4.6,25,4.1c-0.4,1.2-1.2,2.1-2.2,2.8c1-0.1,2-0.4,2.9-0.8 C24.9,7.1,24,7.9,23.1,8.7L23.1,8.7z"></path></svg><span>ツイート</span></a></div></div><div class="View_columnsContainer__mDFW9"><section class="View_content__ioDsV"><div class="View_main__es7o7"><div class="Container_default__wsJLp Container_common__bSTKj"><div class="View_topics__OVMdM"><a class="View_topicLink__c5a39" href="/topics/ai"><div class="View_topicImage__IKBIB"><img class="View_topicImg__vGi6R" loading="lazy" src="https://storage.googleapis.com/zenn-user-upload/topics/23eef6d9d7.png"></div><div class="View_topicName__rxKth">AI</div></a><a class="View_topicLink__c5a39" href="/topics/rust"><div class="View_topicImage__IKBIB"><img class="View_topicImg__vGi6R" loading="lazy" src="https://storage.googleapis.com/zenn-user-upload/topics/ba09661577.png"></div><div class="View_topicName__rxKth">Rust</div></a><a class="View_topicLink__c5a39" href="/topics/%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0"><div class="View_topicImage__IKBIB"><img class="View_topicImg__vGi6R" loading="lazy" src="https://storage.googleapis.com/zenn-user-upload/topics/5b2d2a2b03.jpeg"></div><div class="View_topicName__rxKth">アルゴリズム</div></a><a class="View_topicLink__c5a39" href="/topics/%E6%9C%80%E9%81%A9%E5%8C%96"><span class="View_topicHash__btZwg">#</span><div class="View_topicName__rxKth">最適化</div></a><a class="View_topicLink__c5a39" href="/topics/%E7%B5%8C%E8%B7%AF%E6%8E%A2%E7%B4%A2"><span class="View_topicHash__btZwg">#</span><div class="View_topicName__rxKth">経路探索</div></a><a class="View_topicLink__c5a39" href="/tech-or-idea"><div class="View_topicImage__IKBIB"><img class="View_topicImg__vGi6R" loading="lazy" src="https://zenn.dev/images/drawing/tech-icon.svg"></div><div class="View_topicName__rxKth" style="text-transform:capitalize">tech</div></a></div><div class="InsertCopyButtonToCodeBlock_insertCopyButtonWrapper__tRZUu"><div class="znc BodyContent_anchorToHeadings__Vl0_u"><p>ChatGPT の勢いがすごいですね。きっと我々の仕事はなくなるのでしょう。<br>
そんな中、空気を読まずに経路探索のアルゴリズムについて語ります。</p>
<p>この記事は <a href="https://github.com/msakuta/swarm-rs" target="_blank" rel="nofollow noopener noreferrer">swarm-rs</a> というゲーム実装のノートの一部 (<a href="https://github.com/msakuta/swarm-rs/wiki" target="_blank" rel="nofollow noopener noreferrer">こちら</a>) を翻訳し、少し肉付けしたものです。</p>
<p>まず前提ですが、経路探索するのは二次元の占有グリッド(Occupancy grid)の中です。<br>
地形情報がバイナリイメージとして与えられていると考えても良いです。</p>
<p>経路探索のアルゴリズムとしては、ダイクストラ法とA*が有名ですが、これらについては良い教材が腐るほどあるので触れません。<br>
ただ、どちらも探索空間をグラフとして表現することを前提とします。<br>
占有グリッドをそのまま探索空間とすると、ゴールに至るまでのピクセルのほとんどを評価する必要があるので、探索計算が非常に長くなる傾向があります。<br>
ここでは、バイナリイメージで与えられた探索空間をいかに探索に適した形に軽量化するかを考えます。</p>
<h1 id="%E3%83%88%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%82%AE%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3">
<a class="header-anchor-link" href="#%E3%83%88%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%82%AE%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" aria-hidden="true"></a> トライアンギュレーション</h1>
<p>ゲームの世界ではAIの経路探索に使うデータ構造をナビゲーションメッシュなどと呼んだりします。<br>
これはポリゴンの集まりで表現された空間の分割です。<br>
このような分割に使われるアルゴリズムの一つがドロネー三角形分割です。<br>
トライアンギュレーションとも呼ばれます。</p>
<p>探索空間が非常に小さくなり、探索を高速化することができますが、事前にドロネー三角形分割を実施しておく必要があるので、動的に変化する環境に適応するのは得意ではありません。</p>
<p><img src="https://user-images.githubusercontent.com/2798715/208233706-0ff9f0ed-acaa-46c0-87db-ccc774f166f0.gif" alt="Swarm-rs 2022-12-17 17-35-58_edit" loading="lazy" class="md-img"></p>
<p>ドロネー三角形分割の利点は、占有グリッドの輪郭の複雑度に応じて動的にナビゲーションメッシュの細かさが変わることです。このことで、シンプルな形状には疎な三角形を使い、複雑な形状には密な三角形を使うことができ、資源の最適化ができます。<br>
ピクセル単位のギザギザはRDPなどのアルゴリズムで単純化しておいた方が疎な三角形分割になります。</p>
<p><img src="https://user-images.githubusercontent.com/2798715/211263110-d20760ab-ea4b-4e6c-8839-4f95dcdb0575.png" alt="image" loading="lazy" class="md-img"></p>
<p>しかし、ドロネー三角形分割は計算コストが高く、毎フレーム実行することはできません。<br>
変化する環境に適応する、特に障害物回避には使えません。</p>
<p>具体的な構築方法については、結局次に述べる四分木メッシュをメインに使うことにしたので詳しくは述べませんが、おおむね次のようなステップになります。</p>
<ol>
<li>占有グリッドをバイナリイメージとして用意する。(上の図では Perlin noise を使っています)</li>
<li>Marching Squares アルゴリズムで境界のピクセルを抽出する</li>
<li>RDP アルゴリズムで単純化する</li>
<li>ドロネー三角形分割を実施する (delaunator という crate を使っています)</li>
<li>隣り合う三角形の距離に応じて探索コストを定義する</li>
</ol>
<h1 id="%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5">
<a class="header-anchor-link" href="#%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5" aria-hidden="true"></a> 四分木メッシュ</h1>
<p>もう一つの方法は、四分木でナビゲーションメッシュを構築することです。<br>
(<a href="https://www.researchgate.net/publication/235443232_Using_Quadtrees_for_Realtime_Pathfinding_in_Indoor_Environments" target="_blank" rel="nofollow noopener noreferrer">こちらの論文</a>がベースになっています)。<br>
四分木の利点は、本質的に局所的であることで、構築するのに隣のセルをチェックする必要がありません。<br>
このため、占有グリッドに変化があっても、それの再計算が局所的で済むという特徴があります。</p>
<p>また、ドロネー三角形分割では境界を単純化しておかないと十分に疎なメッシュになりませんでしたが、四分木ではその必要はないのも良いところです。</p>
<p>四分木の欠点は、トライアンギュレーションに比べるとノードの数が多く、メモリ使用量と探索コストの軽量化という点では敵わないところです。</p>
<p><img src="https://user-images.githubusercontent.com/2798715/211260262-bbbc210b-311e-4422-bdb7-62523e781e79.png" alt="image" loading="lazy" class="md-img"></p>
<p>とは言え、それなりに疎な探索グラフは構築できます。</p>
<p><img src="https://user-images.githubusercontent.com/2798715/211263470-2dde8001-7cd5-4450-98f6-a821bf75f7e5.png" alt="image" loading="lazy" class="md-img"></p>
<p>四分木メッシュの構築方法は非常にシンプルです。<br>
下記のような再帰的アルゴリズムで実現できます。</p>
<ol>
<li>最上位のノード(マップ全てのピクセルを含む)をチェック対象のセルとする</li>
<li>チェックするセルに含まれるピクセルを全てスキャンする</li>
<li>ピクセルが一様(Homogeneous)であればそのセルを葉ノードとする</li>
<li>ピクセルが非一様(Heterogeneous)であればそのセルを四分割したノードとし、4つの子ノードをチェック対象とする</li>
<li>2.に戻る</li>
</ol>
<h1 id="%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E5%8B%95%E7%9A%84%E6%9B%B4%E6%96%B0">
<a class="header-anchor-link" href="#%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E5%8B%95%E7%9A%84%E6%9B%B4%E6%96%B0" aria-hidden="true"></a> 四分木メッシュの動的更新</h1>
<p>四分木の構築は比較的低コストなので、毎フレーム行うこともできます。<br>
これによって動的な障害物を回避するようなグローバルな経路探索も可能になります。<sup class="footnote-ref"><a href="#fn-8b34-1" id="fnref-8b34-1">[1]</a></sup></p>
<p>まず、セルの取りうる状態を、占有と非占有の二通りだけではなく、動的な障害物がある場合も状態に加えます。<br>
swarm-rs では下記のような列挙型にしています。</p>
<div class="code-block-container"><div class="InsertCopyButtonToCodeBlock_codeBlockWrapper__XcDZh"><pre class="language-rust" data-has-copy-button="true"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">CellState</span> <span class="token punctuation">{</span>
    <span class="token class-name">Obstacle</span><span class="token punctuation">,</span>
    <span class="token class-name">Occupied</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Free</span><span class="token punctuation">,</span>
    <span class="token class-name">Mixed</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><button class="InsertCopyButtonToCodeBlock_copyButton__EvDpx" data-tooltip-position="top-left" aria-label="クリップボードにコピー"><img src="https://zenn.dev/images/copy-icon.svg" class="InsertCopyButtonToCodeBlock_copyIcon__sLCZD"></button></div></div><p><code>Occupied(usize)</code> がエージェントが占有しているセルの状態です。ペイロードの <code>usize</code> はエージェントの id を示しています。これは経路探索で自分自身でブロックされてしまうのを回避するためです。</p>
<p><code>Mixed</code> はノードが混ざった状態ピクセルを持ち、子ノードを持つ(非葉ノードである)ということを示します。</p>
<p>下の図では、緑の正方形は空いている葉で、赤い正方形は静的な障害物で占有された葉で、紫は動的な障害物(エージェント)で占有された葉です。<br>
それぞれのエージェントは別々の経路を取る傾向が見て取れると思います。<br>
これはお互いを障害物として経路探索から除外しているからです。</p>
<p><img src="https://user-images.githubusercontent.com/2798715/214132497-8cad42db-3a47-43c8-8651-a36cfb30e030.png" alt="image" loading="lazy" class="md-img"></p>
<p>実はランダム木ベースの動的障害物回避も試したのですが、計算コストが高くなる傾向にあり、結局は四分木を使うことにしました。<br>
特に swarm-rs では多数のエージェントをシミュレートしますので、ランダム木のようにエージェントごとに探索グラフの再構築を行うアルゴリズムはうまくスケールしません。<br>
四分木はグローバルな探索グラフなので、エージェント間で再利用ができ、フレーム内で一度更新するだけで済みます。</p>
<h1 id="%E5%A4%89%E6%9B%B4%E3%81%AE%E3%81%82%E3%81%A3%E3%81%9F%E3%82%BB%E3%83%AB%E3%81%AE%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AA%E6%9B%B4%E6%96%B0">
<a class="header-anchor-link" href="#%E5%A4%89%E6%9B%B4%E3%81%AE%E3%81%82%E3%81%A3%E3%81%9F%E3%82%BB%E3%83%AB%E3%81%AE%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AA%E6%9B%B4%E6%96%B0" aria-hidden="true"></a> 変更のあったセルの効率的な更新</h1>
<p>さらに大きなマップに対応するために、最適化をもっと進めることを考えます。</p>
<p>占有グリッドのほとんどのピクセルは変化しません。<br>
エージェントがいるセルだけが変化します。<br>
従って、変化があった部分だけを更新するようにアルゴリズムを最適化すれば、さらに高速になると考えられます。</p>
<p>まず、準備するのは2つのキャッシュマップです。<br>
キャッシュマップとは、占有グリッドと同じ大きさを持つ2次元配列で、要素は前に述べた <code>CellState</code> です。<br>
一つ目のキャッシュマップは現在のマップの状態を表し、二つ目のキャッシュマップは一つ前のマップの状態を表します。<br>
これはコード中では次のような構造体で <code>map</code> および <code>prev_map</code> としてモデル化されています。</p>
<div class="code-block-container"><div class="InsertCopyButtonToCodeBlock_codeBlockWrapper__XcDZh"><pre class="language-rust" data-has-copy-button="true"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CacheMap</span> <span class="token punctuation">{</span>
    <span class="token comment">/// An internal map having the size (2 ^ toplevel) ^ 2, indicating index into [`cache_buf`]</span>
    map<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">/// An array of actual values in [`cache_map`], extracted to reduce the pixel size.</span>
    buf<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">CellState</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    topbit<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    size<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    <span class="token comment">/// A history of recently updated cells for visualization</span>
    <span class="token keyword">pub</span> fresh_cells<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">;</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    prev_map<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><button class="InsertCopyButtonToCodeBlock_copyButton__EvDpx" data-tooltip-position="top-left" aria-label="クリップボードにコピー"><img src="https://zenn.dev/images/copy-icon.svg" class="InsertCopyButtonToCodeBlock_copyIcon__sLCZD"></button></div></div><p>ちょっとした最適化を施してあり、キャッシュマップは <code>CellState</code> そのものの二次元配列ではなく、 <code>buf: Vec&lt;CellState&gt;</code> へのインデックスを <code>u32</code> で表しています。これは <code>CellState</code> のサイズは 64bit コンピュータでは 16 バイトと大きくなりがちなので、大きな配列を避けるための indirection です。 <sup class="footnote-ref"><a href="#fn-8b34-2" id="fnref-8b34-2">[2]</a></sup><br>
例えば、 512 x 512 ピクセルのマップでは、 16 バイトの要素の配列は 4MB になります。<br>
u32 であれば要素は 4 バイトなので 1MB で済みます。<br>
エージェントの id が 42億を超えるような値にならない限りは、オーバーフローの心配もないでしょう。<br>
メモリ上のマップのサイズを抑えることで、 CPU のキャッシュのヒット率を上げることを期待しています。</p>
<p>さて、差分の検出には、単純に現在のキャッシュマップと前のキャッシュマップを比較して、違いを見つけるということをします。<br>
このためには全てのピクセルを比較しながらスキャンしないといけないので、マップのピクセル数に比例した計算量ですが<sup class="footnote-ref"><a href="#fn-8b34-3" id="fnref-8b34-3">[3]</a></sup>、四分木の更新は次に述べるアルゴリズムで変更のあった部分だけに絞られます。</p>
<ol>
<li>現在のキャッシュマップにエージェントの位置を反映した状態ラベルを書き込む</li>
<li>前のキャッシュマップと現在のそれを比較し、違いのあるピクセルを更新対象とする</li>
<li>更新対象となるピクセルを四分木から見つける</li>
<li>四分木の葉がピクセルではない場合、再帰的に分割してピクセル単位になるまで細分化する</li>
<li>ピクセルを新しいラベルに置き換える</li>
<li>置き換えた結果、親のノードが一様になるかどうかを確かめる</li>
<li>一様であればノードをマージして親ノードのみにする</li>
<li>
<ol start="6">
<li>から繰り返す</li>
</ol>
</li>
</ol>
<p>次の GIF アニメでは、四分木が動的に更新されていく様子を示しています。<br>
緑や赤で一瞬光るセルが変化のあったセルで、それを含むノードのみが再計算されています。<br>
計算速度は、私の環境では 1ms ぐらいから 0.05ms ぐらいまで高速化されました。</p>
<p><img src="https://user-images.githubusercontent.com/2798715/215271788-8b86b979-75f0-477f-9179-00ac40510bc1.gif" alt="swarm-rs5" loading="lazy" class="md-img"></p>
<section class="footnotes">
<span class="footnotes-title">脚注</span>
<ol class="footnotes-list">
<li id="fn-8b34-1" class="footnote-item">
<p>多くの実装では障害物回避はローカルな経路探索にすると思います。動的障害物は普通はエージェントの近くにあるので、全経路の再計算までは必要ないことがほとんどです。しかし、ここでは実装の単純化を目的にグローバルな経路探索で動的障害物回避までしてしまいます。ローカルな障害物回避についてはそのうち別記事にするかもしれません。 <a href="#fnref-8b34-1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn-8b34-2" class="footnote-item">
<p><code>CellState</code> が 16 バイトも使うというのは、ちょっと納得いきがたいところはありますが、<code>Occupied(usize)</code> というバリアントを持つことから、 usize が 64bit コンピュータでは 8 バイトであることと、識別フラグが 1 バイトであってもアラインメントで 8 の倍数に引き上げられてしまうことによります。 <a href="#fnref-8b34-2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn-8b34-3" class="footnote-item">
<p>四分木のデータ構造から違いを検出することも原理的にはできると思いますが、ここでは実装のシンプルさを優先して2つのフラットなキャッシュマップの比較を行います。また、フラットなマップの比較は CPU にとっては非常に分岐予測を利かせやすく、四分木の構築のようにランダムにメモリを飛び回るのに比べて極めて速いと考えられます。 <a href="#fnref-8b34-3" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
</div></div><div class="View_actions__mm37P" id="share"><div class="LikeButton_container__lhHqp style-large"><button aria-label="いいね" class="LikeButton_button__uWgw1"><svg class="LikeButton_svgLike___dmwM" viewBox="0 0 110 110"><path class="LikeButton_svgLikeLine__ncYg7" d="M73,24a23.78,23.78,0,0,0-15.89,6.19,3.14,3.14,0,0,1-4.18,0A23.81,23.81,0,0,0,37,24a22,22,0,0,0-22,22c0,16.67,19.64,32.82,25.11,37.93,2.84,2.65,6.15,5.64,8.92,8.13a8.9,8.9,0,0,0,11.9,0c2.77-2.49,6.07-5.48,8.91-8.13C75.37,78.81,95,62.66,95,46A22,22,0,0,0,73,24Z" fill="currentColor"></path><path class="LikeButton_svgLikeInner__AOG_t" d="M66.25,76.42c-.71.64-1.32,1.2-1.82,1.67-2.51,2.33-5.39,5-7.94,7.25a2.21,2.21,0,0,1-3,0C51,83,48.1,80.42,45.59,78.09c-.5-.47-1.12-1-1.82-1.67C38.09,71.29,23,57.67,23,46A14,14,0,0,1,37,32a15.92,15.92,0,0,1,11.65,5.23l4.73,5a2.2,2.2,0,0,0,3.23,0l4.72-5A16.06,16.06,0,0,1,73,32,14,14,0,0,1,87,46C87,57.67,71.93,71.29,66.25,76.42Z" fill="currentColor"></path><g class="LikeButton_svgLikeDecoration__X2v53"><circle cx="41.5" cy="9.5" fill="#3ea8ff" r="3.5"></circle><circle cx="98.5" cy="26.5" fill="#ffdc6e" r="3.5"></circle><circle cx="13" cy="19" fill="#c067f4" r="5"></circle><circle cx="77" cy="9" fill="#f76685" r="5"></circle><circle cx="26.5" cy="92.5" fill="#f76685" r="3.5"></circle><circle cx="105.5" cy="48.5" fill="#c067f4" r="3.5"></circle><circle cx="4.5" cy="60.5" fill="#3ea8ff" r="3.5"></circle><circle cx="94.5" cy="73.5" fill="#3ea8ff" r="1.5"></circle><circle cx="16.5" cy="75.5" fill="#ffdc6e" r="1.5"></circle><circle cx="78.5" cy="91.5" fill="#ffdc6e" r="1.5"></circle></g></svg></button><span class="LikeButton_likedCount__oJfwh">25</span></div><div class="View_menu__Bjjm7"><button class="View_menuButton__qrHnf"><svg viewBox="0 0 27 27" aria-label="その他の操作" height="17" width="17"><path fill="currentColor" d="M12.74,20.53,3.48,11.35a.75.75,0,0,1,0-1.07L4.71,9.05a.75.75,0,0,1,1.07,0l7.49,7.41,7.49-7.41a.74.74,0,0,1,1.06,0l1.24,1.23a.77.77,0,0,1,0,1.07L13.8,20.53A.74.74,0,0,1,12.74,20.53Z"></path></svg></button></div><span style="display:block;width:16px;height:1px;flex-shrink:0"></span><a class="ShareButtons_button__q3i3s" href="https://twitter.com/intent/tweet?url=https://zenn.dev/msakuta/articles/fdea72a964dd08&amp;text=%5BRust%5D%20%E5%9B%9B%E5%88%86%E6%9C%A8%E3%81%AB%E3%82%88%E3%82%8B%E7%B5%8C%E8%B7%AF%E6%8E%A2%E7%B4%A2%EF%BD%9Cmsakuta&amp;hashtags=zenn" id="gtm-article-footer-tweet" rel="nofollow noopener noreferrer" target="_blank"><svg x="0px" y="0px" viewBox="0 0 27 27" style="enable-background:new 0 0 27 27" xml:space="preserve"><path fill="currentColor" d="M23.1,8.7c0,0.2,0,0.5,0,0.7c0,8-6.4,14.5-14.4,14.6c-0.1,0-0.1,0-0.2,0c-2.8,0-5.5-0.8-7.9-2.3c0.4,0,0.8,0.1,1.2,0.1 c2.3,0,4.6-0.8,6.3-2.1C6,19.6,4,18.2,3.3,16c0.3,0.1,0.7,0.1,1,0.1c0.5,0,0.9-0.1,1.4-0.2c-2.4-0.5-4.1-2.6-4.1-5.1v-0.1 c0.7,0.4,1.5,0.6,2.3,0.7c-1.5-1-2.2-2.5-2.2-4.3c0-0.9,0.2-1.8,0.7-2.6C5,7.8,8.8,9.7,13,9.9c-0.1-0.4-0.1-0.8-0.1-1.2 c0-2.8,2.2-5.2,5.2-5.2c1.5,0,2.8,0.6,3.8,1.7C23,5,24,4.6,25,4.1c-0.4,1.2-1.2,2.1-2.2,2.8c1-0.1,2-0.4,2.9-0.8 C24.9,7.1,24,7.9,23.1,8.7L23.1,8.7z"></path></svg><span>ツイート</span></a></div><span style="display:block;width:1px;height:1.3rem;flex-shrink:0"></span><aside class="View_authorInfo__O6Xhw"><div class="ProfileCard_container__C7toa"><a class="ProfileCard_avatar__yI2q3" href="/msakuta"><img alt="msakuta" class="AvatarImage_plain__BCJNs " height="80" loading="lazy" referrerpolicy="no-referrer" src="https://lh3.googleusercontent.com/a/AATXAJxnmgFXBRlf2ieXuAip8oKhWiOaRs86utsZW07z=s96-c" width="80"></a><div class="ProfileCard_name__ufo2s"><a class="ProfileCard_displayName__bHra8" href="/msakuta">msakuta</a></div><div class="ProfileCard_content__Mt5Fz"><p class="ProfileCard_bio__yQk7x">C, C++, JavaScript, TypeScript, Python を主に使います。最近はほぼ Rust 信者です。</p><div class="ProfileCard_actions__MFv5j"><span class="ProfileCard_follow__kI69V"><button class="ButtonFollow_button__BMHcC style-small">フォロー</button></span></div></div></div></aside></div></div><div id="discuss"><div class="ArticleComments_commentsContainer__HuIhh"><section class="ArticleComments_comments__XJchN"><div class="ArticleComments_emptyContainer__5CSOM"><h3 class="ArticleComments_emptyTitle__Z_1PV">Discussion</h3><img class="ArticleComments_emptyImg__wjufu" src="https://zenn.dev/images/drawing/discussion.png" width="300"></div></section><div class="ArticleComments_commentForm__GK_SZ"><div class="ArticleComments_commentFormLogin__yRvRU">ログインするとコメントできます<div class="ArticleComments_commentFormLoginButtonContainer__6mKfW"><button class="Button_primary___5_rw Button_baseStyle__cFbiQ Button_medium__Sy_Gq Button_shadow__M_gej Button_fontHero__wJow0 Button_fontBold__dvb52">Login</button></div></div></div></div></div></section><aside class="View_sidebarContainer__fEEGs"><div class="ArticleSidebar_container__GRKfS"><div class="ArticleSidebar_articleInfo__YqxUh ArticleSidebar_sidebarCard__w397P"><dl class="DefinitionList_listContainer__wjQtB"><div class="DefinitionList_item__23wGk"><dt class="DefinitionList_dt__sOvY6"><span class="DefinitionList_itemIconContainer__ISWYB"><svg viewBox="0 0 1024 1024" height="15" width="15"><path fill="currentColor" d="M964.37,981.87A457.62,457.62,0,0,0,692,573.72,302.25,302.25,0,0,0,810.57,333.38,303,303,0,1,0,238.86,473.45a305.91,305.91,0,0,0,84.32,100.38A458.88,458.88,0,0,0,86.65,814.09,449.62,449.62,0,0,0,50.8,981.85a14.64,14.64,0,0,0,14.25,15h72.46a14.51,14.51,0,0,0,14.61-14.24,355.59,355.59,0,0,1,710.93,0,14.52,14.52,0,0,0,14.62,14.26h72.09a14.63,14.63,0,0,0,14.62-14.61ZM709.25,333.38a201.76,201.76,0,1,1-59.09-142.57A200.3,200.3,0,0,1,709.25,333.38Z"></path></svg></span><span class="DefinitionList_itemTitle__E2Zn4">著者</span></dt><dd class="DefinitionList_dd__MESgf"><span class="DefinitionList_childrenContainer__8efC_"><a class="ArticleSidebar_authorLink__ZBDmq" href="/msakuta"><img alt="@msakuta" class="AvatarImage_plain__BCJNs " height="22" loading="lazy" referrerpolicy="no-referrer" src="https://lh3.googleusercontent.com/a/AATXAJxnmgFXBRlf2ieXuAip8oKhWiOaRs86utsZW07z=s96-c" width="22"><div class="ArticleSidebar_authorName__jM_by">msakuta</div></a></span></dd></div><div class="DefinitionList_item__23wGk"><dt class="DefinitionList_dt__sOvY6"><span class="DefinitionList_itemIconContainer__ISWYB"><svg x="0px" y="0px" viewBox="0 0 24 24" enable-background="new 0 0 24 24" xml:space="preserve" height="14" width="14"><path fill="currentColor" d="M18.2,0.7c-0.8,0-1.4,0.5-1.4,1.3v3.1c0,0.7,0.7,1.3,1.4,1.3c0.7,0,1.4-0.5,1.4-1.3V2 C19.6,1.3,18.9,0.7,18.2,0.7z"></path><path fill="currentColor" d="M5.8,0.7C5,0.7,4.4,1.3,4.4,2v3.1c0,0.7,0.7,1.3,1.4,1.3s1.4-0.5,1.4-1.3V2C7.3,1.3,6.6,0.7,5.8,0.7z"></path><path fill="currentColor" d="M21.7,3.6H2.3c-1.1,0-2,0.9-2,2v15.7c0,1.1,0.9,2,2,2h19.4c1.1,0,2-0.9,2-2V5.5C23.6,4.5,22.8,3.6,21.7,3.6z  M21.4,19.8c0,0.6-0.5,1.1-1.1,1.1H3.4c-0.5,0-0.9-0.4-0.9-0.9V9.7h19V19.8z"></path></svg></span><span class="DefinitionList_itemTitle__E2Zn4">公開</span></dt><dd class="DefinitionList_dd__MESgf"><span class="DefinitionList_childrenContainer__8efC_"><time class="ArticleSidebar_date__dpzqL" datetime="2023-03-18T14:05:15+00:00" itemprop="datePublished">2023/03/18</time></span></dd></div><div class="DefinitionList_item__23wGk"><dt class="DefinitionList_dt__sOvY6"><span class="DefinitionList_itemIconContainer__ISWYB"><svg x="0px" y="0px" viewBox="0 0 27 27" style="enable-background:new 0 0 27 27" xml:space="preserve" height="15" width="15"><path fill="currentColor" d="M4,1.7v23.4c0,0.6,0.5,0.9,0.9,0.9h19c0.3,0,0.7-0.3,0.7-0.7v-18L24.4,7l-5.2-5.7c-0.2-0.2-0.5-0.3-0.7-0.3H4.8 C4.3,0.9,4,1.3,4,1.7z M6.6,3.7h9.8v4.9c0,0.3,0.2,0.5,0.5,0.5h4.9v14.2H6.6C6.6,23.3,6.6,3.7,6.6,3.7z M19.1,4.3l2.4,2.5h-2.4V4.3 z"></path></svg></span><span class="DefinitionList_itemTitle__E2Zn4">文章量</span></dt><dd class="DefinitionList_dd__MESgf"><span class="DefinitionList_childrenContainer__8efC_"><span class="ArticleSidebar_lettersCount__nD__s">約5,600字</span></span></dd></div></dl></div><span style="display:block;width:1px;height:25px;flex-shrink:0"></span><div class="ArticleSidebar_stikcy__eTeB7"><div class="ArticleSidebar_user__UeCE6 ArticleSidebar_sidebarCard__w397P"><div class="SidebarUserBio_container__kwCsb"><a href="/msakuta"><img alt="msakuta" class="AvatarImage_border__33_UE AvatarImage_plain__BCJNs " height="60" loading="lazy" referrerpolicy="no-referrer" src="https://lh3.googleusercontent.com/a/AATXAJxnmgFXBRlf2ieXuAip8oKhWiOaRs86utsZW07z=s96-c" width="60"></a><div class="SidebarUserBio_author__U1p4F"><a class="SidebarUserBio_name__6kFYE" href="/msakuta">msakuta</a><div class="SidebarUserBio_actions__wu_N5"><button class="ButtonFollow_button__BMHcC style-small">フォロー</button></div></div></div><p class="SidebarUserBio_bio__XPYgb">C, C++, JavaScript, TypeScript, Python を主に使います。最近はほぼ Rust 信者です。</p></div><span style="display:block;width:1px;height:25px;flex-shrink:0"></span><div class="ArticleSidebarToc_toc__3nBmG"><div class="ArticleSidebarToc_tocTitle__ESYiu">目次</div><span style="display:block;width:1px;height:0.2rem;flex-shrink:0"></span><div class="ArticleToc_toc__BK7cX"><ol class="ol-depth-1"><li class="active"><a href="#%E3%83%88%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%82%AE%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" class="active">トライアンギュレーション</a></li><li><a href="#%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5">四分木メッシュ</a></li><li><a href="#%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E5%8B%95%E7%9A%84%E6%9B%B4%E6%96%B0">四分木メッシュの動的更新</a></li><li><a href="#%E5%A4%89%E6%9B%B4%E3%81%AE%E3%81%82%E3%81%A3%E3%81%9F%E3%82%BB%E3%83%AB%E3%81%AE%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AA%E6%9B%B4%E6%96%B0">変更のあったセルの効率的な更新</a></li></ol></div></div></div></div></aside></div></div></div></div><div id="related-contents"></div></article><footer class="AppFooter_footer___WHPZ"><div class="Container_wide__i6D5f Container_common__bSTKj"><div class="AppFooter_inner__D10c8"><div class="AppFooter_brandingColumn__KI7vh"><a href="/"><svg x="0px" y="0px" viewBox="0 0 377.4 88.3" height="20" width="85"><title>Zenn</title><g fill="#111"><path d="M233,56.8h-39c0.5,3.5,2.2,6.8,4.8,9.2c2.7,2.3,6.2,3.5,9.8,3.4c2.8,0,5.6-0.5,8.2-1.7c2.5-1.1,4.8-2.8,6.5-5l8.2,9.5 c-2.5,3.4-5.7,6.1-9.5,7.9c-4.6,2.2-9.6,3.3-14.7,3.2c-5.7,0.1-11.4-1.2-16.5-4c-4.5-2.5-8.2-6.3-10.7-10.9s-3.8-9.8-3.7-15.1v-2.2 c-0.1-5.7,1.1-11.3,3.5-16.5c2.2-4.7,5.7-8.6,10.1-11.3c4.7-2.8,10.1-4.2,15.5-4.1c5.2-0.1,10.3,1.1,14.9,3.7 c4.1,2.5,7.4,6.2,9.4,10.5c2.2,5.1,3.3,10.5,3.2,16.1V56.8z M216.1,43.9c0.1-2.9-0.9-5.7-2.8-7.9c-1.8-1.9-4.4-2.9-7.9-2.9 c-2.9-0.1-5.8,1.1-7.7,3.2c-2,2.6-3.3,5.7-3.6,9h22V43.9z"></path><path d="M128.3,67.9h36.1v14.7h-56.9V72l35.8-54.3h-36.2V2.9h56.6v10.4L128.3,67.9z"></path><path d="M248.8,50.7c0-19.1,12.7-29.2,28.2-29.2s27.9,10.1,27.9,29.2V82h-16V51.4c0-10.6-4.8-16.1-12-16.1s-12.4,5.5-12.4,16.1 v30.7h-15.8L248.8,50.7L248.8,50.7z"></path><path d="M320.3,50.7c0-19.1,12.7-29.2,28.2-29.2s27.9,10.1,27.9,29.2V82h-16V51.4c0-10.6-4.8-16.1-12-16.1S336,40.8,336,51.4v30.7 h-15.8L320.3,50.7L320.3,50.7z"></path></g><path fill="#3EA8FF" class="st0" d="M2.4,83.3h17c0.9,0,1.7-0.5,2.2-1.2L68.4,5.2C69,4.2,68.3,3,67.1,3H51c-0.8,0-1.5,0.4-1.9,1.1L1.6,81.9 C1.3,82.5,1.7,83.3,2.4,83.3z"></path><path fill="#3EA8FF" class="st0" d="M61,82.1l22.1-35.5c0.7-1.1-0.1-2.5-1.4-2.5H65.7c-0.6,0-1.2,0.3-1.5,0.8L41.5,81.2c-0.6,0.9,0.1,2.1,1.2,2.1 h16.3C59.8,83.3,60.6,82.9,61,82.1z"></path></svg></a><p class="AppFooter_siteDescription__O_nNG">エンジニアのための<br aria-hidden="true">情報共有コミュニティ</p></div><div class="AppFooter_navColumns__fhusL"><nav class="AppFooter_navColumn__2KSHP"><h4 class="AppFooter_navColumnTitle__jvSZC">About</h4><ul><li><a href="/about">Zennについて</a></li><li><a href="https://classmethod.jp" rel="nofollow noopener noreferrer" target="_blank">運営会社</a></li><li><a href="https://info.zenn.dev" rel="nofollow noopener noreferrer" target="_blank">お知らせ・リリース</a></li></ul></nav><nav class="AppFooter_navColumn__2KSHP"><h4 class="AppFooter_navColumnTitle__jvSZC">Guides</h4><ul><li><a href="/zenn">使い方</a></li><li><a href="/publications">Publication</a></li><li><a href="/faq">よくある質問</a></li></ul></nav><nav class="AppFooter_navColumn__2KSHP"><h4 class="AppFooter_navColumnTitle__jvSZC">Links</h4><ul><li><a href="https://twitter.com/zenn_dev" rel="nofollow noopener noreferrer" target="_blank">Twitter</a></li><li><a href="https://github.com/zenn-dev" rel="nofollow noopener noreferrer" target="_blank">GitHub</a></li><li><a href="/mediakit">メディアキット</a></li></ul></nav><nav class="AppFooter_navColumn__2KSHP"><h4 class="AppFooter_navColumnTitle__jvSZC">Legal</h4><ul><li><a href="/terms">利用規約</a></li><li><a href="/privacy">プライバシーポリシー</a></li><li><a href="/terms/transaction-law">特商法表記</a></li></ul></nav></div></div><div class="AppFooter_copyright__QeZts"><a href="https://classmethod.jp/"><img alt="Classmethod inc." height="25" loading="lazy" src="https://zenn.dev/images/classmethod-logo-small.svg" width="115"></a></div></div></footer><div id="modal-portal"></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"id":155966,"postType":"Article","title":"[Rust] 四分木による経路探索","slug":"fdea72a964dd08","commentsCount":0,"likedCount":25,"bodyLettersCount":5663,"articleType":"tech","emoji":"✨","isSuspendingPrivate":false,"publishedAt":"2023-03-18T23:05:15.249+09:00","bodyUpdatedAt":"2023-03-18T18:55:42.385+09:00","sourceRepoUpdatedAt":null,"path":"/msakuta/articles/fdea72a964dd08","bodyHtml":"\u003cp\u003eChatGPT の勢いがすごいですね。きっと我々の仕事はなくなるのでしょう。\u003cbr\u003e\nそんな中、空気を読まずに経路探索のアルゴリズムについて語ります。\u003c/p\u003e\n\u003cp\u003eこの記事は \u003ca href=\"https://github.com/msakuta/swarm-rs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eswarm-rs\u003c/a\u003e というゲーム実装のノートの一部 (\u003ca href=\"https://github.com/msakuta/swarm-rs/wiki\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eこちら\u003c/a\u003e) を翻訳し、少し肉付けしたものです。\u003c/p\u003e\n\u003cp\u003eまず前提ですが、経路探索するのは二次元の占有グリッド(Occupancy grid)の中です。\u003cbr\u003e\n地形情報がバイナリイメージとして与えられていると考えても良いです。\u003c/p\u003e\n\u003cp\u003e経路探索のアルゴリズムとしては、ダイクストラ法とA*が有名ですが、これらについては良い教材が腐るほどあるので触れません。\u003cbr\u003e\nただ、どちらも探索空間をグラフとして表現することを前提とします。\u003cbr\u003e\n占有グリッドをそのまま探索空間とすると、ゴールに至るまでのピクセルのほとんどを評価する必要があるので、探索計算が非常に長くなる傾向があります。\u003cbr\u003e\nここでは、バイナリイメージで与えられた探索空間をいかに探索に適した形に軽量化するかを考えます。\u003c/p\u003e\n\u003ch1 id=\"%E3%83%88%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%82%AE%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e\n\u003ca class=\"header-anchor-link\" href=\"#%E3%83%88%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%82%AE%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\" aria-hidden=\"true\"\u003e\u003c/a\u003e トライアンギュレーション\u003c/h1\u003e\n\u003cp\u003eゲームの世界ではAIの経路探索に使うデータ構造をナビゲーションメッシュなどと呼んだりします。\u003cbr\u003e\nこれはポリゴンの集まりで表現された空間の分割です。\u003cbr\u003e\nこのような分割に使われるアルゴリズムの一つがドロネー三角形分割です。\u003cbr\u003e\nトライアンギュレーションとも呼ばれます。\u003c/p\u003e\n\u003cp\u003e探索空間が非常に小さくなり、探索を高速化することができますが、事前にドロネー三角形分割を実施しておく必要があるので、動的に変化する環境に適応するのは得意ではありません。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/2798715/208233706-0ff9f0ed-acaa-46c0-87db-ccc774f166f0.gif\" alt=\"Swarm-rs 2022-12-17 17-35-58_edit\" loading=\"lazy\" class=\"md-img\"\u003e\u003c/p\u003e\n\u003cp\u003eドロネー三角形分割の利点は、占有グリッドの輪郭の複雑度に応じて動的にナビゲーションメッシュの細かさが変わることです。このことで、シンプルな形状には疎な三角形を使い、複雑な形状には密な三角形を使うことができ、資源の最適化ができます。\u003cbr\u003e\nピクセル単位のギザギザはRDPなどのアルゴリズムで単純化しておいた方が疎な三角形分割になります。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/2798715/211263110-d20760ab-ea4b-4e6c-8839-4f95dcdb0575.png\" alt=\"image\" loading=\"lazy\" class=\"md-img\"\u003e\u003c/p\u003e\n\u003cp\u003eしかし、ドロネー三角形分割は計算コストが高く、毎フレーム実行することはできません。\u003cbr\u003e\n変化する環境に適応する、特に障害物回避には使えません。\u003c/p\u003e\n\u003cp\u003e具体的な構築方法については、結局次に述べる四分木メッシュをメインに使うことにしたので詳しくは述べませんが、おおむね次のようなステップになります。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e占有グリッドをバイナリイメージとして用意する。(上の図では Perlin noise を使っています)\u003c/li\u003e\n\u003cli\u003eMarching Squares アルゴリズムで境界のピクセルを抽出する\u003c/li\u003e\n\u003cli\u003eRDP アルゴリズムで単純化する\u003c/li\u003e\n\u003cli\u003eドロネー三角形分割を実施する (delaunator という crate を使っています)\u003c/li\u003e\n\u003cli\u003e隣り合う三角形の距離に応じて探索コストを定義する\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1 id=\"%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5\"\u003e\n\u003ca class=\"header-anchor-link\" href=\"#%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5\" aria-hidden=\"true\"\u003e\u003c/a\u003e 四分木メッシュ\u003c/h1\u003e\n\u003cp\u003eもう一つの方法は、四分木でナビゲーションメッシュを構築することです。\u003cbr\u003e\n(\u003ca href=\"https://www.researchgate.net/publication/235443232_Using_Quadtrees_for_Realtime_Pathfinding_in_Indoor_Environments\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eこちらの論文\u003c/a\u003eがベースになっています)。\u003cbr\u003e\n四分木の利点は、本質的に局所的であることで、構築するのに隣のセルをチェックする必要がありません。\u003cbr\u003e\nこのため、占有グリッドに変化があっても、それの再計算が局所的で済むという特徴があります。\u003c/p\u003e\n\u003cp\u003eまた、ドロネー三角形分割では境界を単純化しておかないと十分に疎なメッシュになりませんでしたが、四分木ではその必要はないのも良いところです。\u003c/p\u003e\n\u003cp\u003e四分木の欠点は、トライアンギュレーションに比べるとノードの数が多く、メモリ使用量と探索コストの軽量化という点では敵わないところです。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/2798715/211260262-bbbc210b-311e-4422-bdb7-62523e781e79.png\" alt=\"image\" loading=\"lazy\" class=\"md-img\"\u003e\u003c/p\u003e\n\u003cp\u003eとは言え、それなりに疎な探索グラフは構築できます。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/2798715/211263470-2dde8001-7cd5-4450-98f6-a821bf75f7e5.png\" alt=\"image\" loading=\"lazy\" class=\"md-img\"\u003e\u003c/p\u003e\n\u003cp\u003e四分木メッシュの構築方法は非常にシンプルです。\u003cbr\u003e\n下記のような再帰的アルゴリズムで実現できます。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e最上位のノード(マップ全てのピクセルを含む)をチェック対象のセルとする\u003c/li\u003e\n\u003cli\u003eチェックするセルに含まれるピクセルを全てスキャンする\u003c/li\u003e\n\u003cli\u003eピクセルが一様(Homogeneous)であればそのセルを葉ノードとする\u003c/li\u003e\n\u003cli\u003eピクセルが非一様(Heterogeneous)であればそのセルを四分割したノードとし、4つの子ノードをチェック対象とする\u003c/li\u003e\n\u003cli\u003e2.に戻る\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1 id=\"%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E5%8B%95%E7%9A%84%E6%9B%B4%E6%96%B0\"\u003e\n\u003ca class=\"header-anchor-link\" href=\"#%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E5%8B%95%E7%9A%84%E6%9B%B4%E6%96%B0\" aria-hidden=\"true\"\u003e\u003c/a\u003e 四分木メッシュの動的更新\u003c/h1\u003e\n\u003cp\u003e四分木の構築は比較的低コストなので、毎フレーム行うこともできます。\u003cbr\u003e\nこれによって動的な障害物を回避するようなグローバルな経路探索も可能になります。\u003csup class=\"footnote-ref\"\u003e\u003ca href=\"#fn-8b34-1\" id=\"fnref-8b34-1\"\u003e[1]\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\u003cp\u003eまず、セルの取りうる状態を、占有と非占有の二通りだけではなく、動的な障害物がある場合も状態に加えます。\u003cbr\u003e\nswarm-rs では下記のような列挙型にしています。\u003c/p\u003e\n\u003cdiv class=\"code-block-container\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token attribute attr-name\"\u003e#[derive(Debug, Clone, Copy, PartialEq, Eq)]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eenum\u003c/span\u003e \u003cspan class=\"token type-definition class-name\"\u003eCellState\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eObstacle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eOccupied\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eusize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eFree\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eMixed\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ccode\u003eOccupied(usize)\u003c/code\u003e がエージェントが占有しているセルの状態です。ペイロードの \u003ccode\u003eusize\u003c/code\u003e はエージェントの id を示しています。これは経路探索で自分自身でブロックされてしまうのを回避するためです。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eMixed\u003c/code\u003e はノードが混ざった状態ピクセルを持ち、子ノードを持つ(非葉ノードである)ということを示します。\u003c/p\u003e\n\u003cp\u003e下の図では、緑の正方形は空いている葉で、赤い正方形は静的な障害物で占有された葉で、紫は動的な障害物(エージェント)で占有された葉です。\u003cbr\u003e\nそれぞれのエージェントは別々の経路を取る傾向が見て取れると思います。\u003cbr\u003e\nこれはお互いを障害物として経路探索から除外しているからです。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/2798715/214132497-8cad42db-3a47-43c8-8651-a36cfb30e030.png\" alt=\"image\" loading=\"lazy\" class=\"md-img\"\u003e\u003c/p\u003e\n\u003cp\u003e実はランダム木ベースの動的障害物回避も試したのですが、計算コストが高くなる傾向にあり、結局は四分木を使うことにしました。\u003cbr\u003e\n特に swarm-rs では多数のエージェントをシミュレートしますので、ランダム木のようにエージェントごとに探索グラフの再構築を行うアルゴリズムはうまくスケールしません。\u003cbr\u003e\n四分木はグローバルな探索グラフなので、エージェント間で再利用ができ、フレーム内で一度更新するだけで済みます。\u003c/p\u003e\n\u003ch1 id=\"%E5%A4%89%E6%9B%B4%E3%81%AE%E3%81%82%E3%81%A3%E3%81%9F%E3%82%BB%E3%83%AB%E3%81%AE%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AA%E6%9B%B4%E6%96%B0\"\u003e\n\u003ca class=\"header-anchor-link\" href=\"#%E5%A4%89%E6%9B%B4%E3%81%AE%E3%81%82%E3%81%A3%E3%81%9F%E3%82%BB%E3%83%AB%E3%81%AE%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AA%E6%9B%B4%E6%96%B0\" aria-hidden=\"true\"\u003e\u003c/a\u003e 変更のあったセルの効率的な更新\u003c/h1\u003e\n\u003cp\u003eさらに大きなマップに対応するために、最適化をもっと進めることを考えます。\u003c/p\u003e\n\u003cp\u003e占有グリッドのほとんどのピクセルは変化しません。\u003cbr\u003e\nエージェントがいるセルだけが変化します。\u003cbr\u003e\n従って、変化があった部分だけを更新するようにアルゴリズムを最適化すれば、さらに高速になると考えられます。\u003c/p\u003e\n\u003cp\u003eまず、準備するのは2つのキャッシュマップです。\u003cbr\u003e\nキャッシュマップとは、占有グリッドと同じ大きさを持つ2次元配列で、要素は前に述べた \u003ccode\u003eCellState\u003c/code\u003e です。\u003cbr\u003e\n一つ目のキャッシュマップは現在のマップの状態を表し、二つ目のキャッシュマップは一つ前のマップの状態を表します。\u003cbr\u003e\nこれはコード中では次のような構造体で \u003ccode\u003emap\u003c/code\u003e および \u003ccode\u003eprev_map\u003c/code\u003e としてモデル化されています。\u003c/p\u003e\n\u003cdiv class=\"code-block-container\"\u003e\u003cpre class=\"language-rust\"\u003e\u003ccode class=\"language-rust\"\u003e\u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token type-definition class-name\"\u003eCacheMap\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e/// An internal map having the size (2 ^ toplevel) ^ 2, indicating index into [`cache_buf`]\u003c/span\u003e\n    map\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eVec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e/// An array of actual values in [`cache_map`], extracted to reduce the pixel size.\u003c/span\u003e\n    buf\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eVec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eCellState\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    topbit\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eusize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    size\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eusize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e/// A history of recently updated cells for visualization\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e fresh_cells\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHashMap\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eusize\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    prev_map\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eOption\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eVec\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eu32\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eちょっとした最適化を施してあり、キャッシュマップは \u003ccode\u003eCellState\u003c/code\u003e そのものの二次元配列ではなく、 \u003ccode\u003ebuf: Vec\u0026lt;CellState\u0026gt;\u003c/code\u003e へのインデックスを \u003ccode\u003eu32\u003c/code\u003e で表しています。これは \u003ccode\u003eCellState\u003c/code\u003e のサイズは 64bit コンピュータでは 16 バイトと大きくなりがちなので、大きな配列を避けるための indirection です。 \u003csup class=\"footnote-ref\"\u003e\u003ca href=\"#fn-8b34-2\" id=\"fnref-8b34-2\"\u003e[2]\u003c/a\u003e\u003c/sup\u003e\u003cbr\u003e\n例えば、 512 x 512 ピクセルのマップでは、 16 バイトの要素の配列は 4MB になります。\u003cbr\u003e\nu32 であれば要素は 4 バイトなので 1MB で済みます。\u003cbr\u003e\nエージェントの id が 42億を超えるような値にならない限りは、オーバーフローの心配もないでしょう。\u003cbr\u003e\nメモリ上のマップのサイズを抑えることで、 CPU のキャッシュのヒット率を上げることを期待しています。\u003c/p\u003e\n\u003cp\u003eさて、差分の検出には、単純に現在のキャッシュマップと前のキャッシュマップを比較して、違いを見つけるということをします。\u003cbr\u003e\nこのためには全てのピクセルを比較しながらスキャンしないといけないので、マップのピクセル数に比例した計算量ですが\u003csup class=\"footnote-ref\"\u003e\u003ca href=\"#fn-8b34-3\" id=\"fnref-8b34-3\"\u003e[3]\u003c/a\u003e\u003c/sup\u003e、四分木の更新は次に述べるアルゴリズムで変更のあった部分だけに絞られます。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e現在のキャッシュマップにエージェントの位置を反映した状態ラベルを書き込む\u003c/li\u003e\n\u003cli\u003e前のキャッシュマップと現在のそれを比較し、違いのあるピクセルを更新対象とする\u003c/li\u003e\n\u003cli\u003e更新対象となるピクセルを四分木から見つける\u003c/li\u003e\n\u003cli\u003e四分木の葉がピクセルではない場合、再帰的に分割してピクセル単位になるまで細分化する\u003c/li\u003e\n\u003cli\u003eピクセルを新しいラベルに置き換える\u003c/li\u003e\n\u003cli\u003e置き換えた結果、親のノードが一様になるかどうかを確かめる\u003c/li\u003e\n\u003cli\u003e一様であればノードをマージして親ノードのみにする\u003c/li\u003e\n\u003cli\u003e\n\u003col start=\"6\"\u003e\n\u003cli\u003eから繰り返す\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e次の GIF アニメでは、四分木が動的に更新されていく様子を示しています。\u003cbr\u003e\n緑や赤で一瞬光るセルが変化のあったセルで、それを含むノードのみが再計算されています。\u003cbr\u003e\n計算速度は、私の環境では 1ms ぐらいから 0.05ms ぐらいまで高速化されました。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/2798715/215271788-8b86b979-75f0-477f-9179-00ac40510bc1.gif\" alt=\"swarm-rs5\" loading=\"lazy\" class=\"md-img\"\u003e\u003c/p\u003e\n\u003csection class=\"footnotes\"\u003e\n\u003cspan class=\"footnotes-title\"\u003e脚注\u003c/span\u003e\n\u003col class=\"footnotes-list\"\u003e\n\u003cli id=\"fn-8b34-1\" class=\"footnote-item\"\u003e\n\u003cp\u003e多くの実装では障害物回避はローカルな経路探索にすると思います。動的障害物は普通はエージェントの近くにあるので、全経路の再計算までは必要ないことがほとんどです。しかし、ここでは実装の単純化を目的にグローバルな経路探索で動的障害物回避までしてしまいます。ローカルな障害物回避についてはそのうち別記事にするかもしれません。 \u003ca href=\"#fnref-8b34-1\" class=\"footnote-backref\"\u003e↩︎\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"fn-8b34-2\" class=\"footnote-item\"\u003e\n\u003cp\u003e\u003ccode\u003eCellState\u003c/code\u003e が 16 バイトも使うというのは、ちょっと納得いきがたいところはありますが、\u003ccode\u003eOccupied(usize)\u003c/code\u003e というバリアントを持つことから、 usize が 64bit コンピュータでは 8 バイトであることと、識別フラグが 1 バイトであってもアラインメントで 8 の倍数に引き上げられてしまうことによります。 \u003ca href=\"#fnref-8b34-2\" class=\"footnote-backref\"\u003e↩︎\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"fn-8b34-3\" class=\"footnote-item\"\u003e\n\u003cp\u003e四分木のデータ構造から違いを検出することも原理的にはできると思いますが、ここでは実装のシンプルさを優先して2つのフラットなキャッシュマップの比較を行います。また、フラットなマップの比較は CPU にとっては非常に分岐予測を利かせやすく、四分木の構築のようにランダムにメモリを飛び回るのに比べて極めて速いと考えられます。 \u003ca href=\"#fnref-8b34-3\" class=\"footnote-backref\"\u003e↩︎\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e\n","ogImageUrl":"https://res.cloudinary.com/zenn/image/upload/s--hal_3QHt--/c_fit%2Cg_north_west%2Cl_text:notosansjp-medium.otf_55:%255BRust%255D%2520%25E5%259B%259B%25E5%2588%2586%25E6%259C%25A8%25E3%2581%25AB%25E3%2582%2588%25E3%2582%258B%25E7%25B5%258C%25E8%25B7%25AF%25E6%258E%25A2%25E7%25B4%25A2%2Cw_1010%2Cx_90%2Cy_100/g_south_west%2Cl_text:notosansjp-medium.otf_37:msakuta%2Cx_203%2Cy_98/g_south_west%2Ch_90%2Cl_fetch:aHR0cHM6Ly9saDMuZ29vZ2xldXNlcmNvbnRlbnQuY29tL2EvQUFUWEFKeG5tZ0ZYQlJsZjJpZVh1QWlwOG9LaFdpT2FSczg2dXRzWlcwN3o9czk2LWM=%2Cr_max%2Cw_90%2Cx_87%2Cy_72/og-base.png","toc":[{"id":"%E3%83%88%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%82%AE%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3","text":"トライアンギュレーション","level":1,"children":[]},{"id":"%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5","text":"四分木メッシュ","level":1,"children":[]},{"id":"%E5%9B%9B%E5%88%86%E6%9C%A8%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E5%8B%95%E7%9A%84%E6%9B%B4%E6%96%B0","text":"四分木メッシュの動的更新","level":1,"children":[]},{"id":"%E5%A4%89%E6%9B%B4%E3%81%AE%E3%81%82%E3%81%A3%E3%81%9F%E3%82%BB%E3%83%AB%E3%81%AE%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AA%E6%9B%B4%E6%96%B0","text":"変更のあったセルの効率的な更新","level":1,"children":[]}],"tocEnabled":true,"shouldNoindex":false,"scheduledPublishAt":null,"canSendBadge":false,"status":"published","badges":[]},"user":{"id":72689,"username":"msakuta","name":"msakuta","avatarSmallUrl":"https://lh3.googleusercontent.com/a/AATXAJxnmgFXBRlf2ieXuAip8oKhWiOaRs86utsZW07z=s96-c","avatarUrl":"https://lh3.googleusercontent.com/a/AATXAJxnmgFXBRlf2ieXuAip8oKhWiOaRs86utsZW07z=s96-c","bio":"C, C++, JavaScript, TypeScript, Python を主に使います。最近はほぼ Rust 信者です。","autolinkedBio":"C, C++, JavaScript, TypeScript, Python を主に使います。最近はほぼ Rust 信者です。","githubUsername":null,"twitterUsername":null,"isSupportOpen":false,"tokusyoContact":null,"tokusyoName":null,"websiteUrl":null,"websiteDomain":null,"totalLikedCount":234,"gaTrackingId":null,"hatenaId":null},"topics":[{"id":4,"name":"ai","displayName":"AI","taggingsCount":671,"imageUrl":"https://storage.googleapis.com/zenn-user-upload/topics/23eef6d9d7.png"},{"id":104,"name":"rust","displayName":"Rust","taggingsCount":1911,"imageUrl":"https://storage.googleapis.com/zenn-user-upload/topics/ba09661577.png"},{"id":1076,"name":"アルゴリズム","displayName":"アルゴリズム","taggingsCount":163,"imageUrl":"https://storage.googleapis.com/zenn-user-upload/topics/5b2d2a2b03.jpeg"},{"id":5285,"name":"最適化","displayName":"最適化","taggingsCount":32,"imageUrl":null},{"id":21111,"name":"経路探索","displayName":"経路探索","taggingsCount":1,"imageUrl":null}],"isMine":false,"isPreview":false,"githubRepository":null,"currentUserLiked":false,"comments":[],"commentedUsers":[],"positiveCommentsCount":0,"publication":null}},"page":"/[username]/articles/[slug]","query":{"username":"msakuta","slug":"fdea72a964dd08"},"buildId":"piX8DDrzno6pbqKClrLHx","assetPrefix":"https://zenn.dev","isFallback":false,"gip":true,"scriptLoader":[]}</script><next-route-announcer><p aria-live="assertive" id="__next-route-announcer__" role="alert" style="border: 0px; clip: rect(0px, 0px, 0px, 0px); height: 1px; margin: -1px; overflow: hidden; padding: 0px; position: absolute; width: 1px; white-space: nowrap; overflow-wrap: normal;"></p></next-route-announcer></body></html>